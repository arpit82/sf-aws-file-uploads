# Salesforce → Amazon S3 Direct File Upload

A production-ready pattern where **Salesforce** orchestrates the workflow and the **browser uploads directly to Amazon S3** using short-lived presigned URLs generated by **AWS Lambda + API Gateway**, authenticated via a **Salesforce External Credential + Named Credential**.

This solution avoids Apex binary handling entirely and supports secure, scalable upload flows with a Lightning Web Component progress bar.

---

## Table of Contents

- Overview
- Repo Structure
- Prerequisites
- AWS Setup
  - 1. Create S3 Bucket
  - 2. Configure IAM Role
  - 3. Lambda Setup
  - 4. API Gateway Setup
  - 5. Usage Plan + API Key
- Salesforce Setup
  - 1. External Credential
  - 2. Permission Set Mapping
  - 3. Named Credential
  - 4. CSP Trusted Sites
  - 5. Deploy Apex
  - 6. Deploy LWC
- Testing
- Troubleshooting
- Security Notes
- Appendix

---

# Overview

This implementation supports:

- Direct **browser → S3 uploads**
- **No file bodies pass through Apex**
- **AWS Lambda** generates short-lived presigned URLs
- **API Gateway** authenticates using API Key
- **Salesforce Named Credential + External Credential** securely pass the API key
- LWC uses **XHR** to upload files with a progress bar

**AWS Services**
- Amazon S3
- AWS Lambda (Python, boto3)
- Amazon API Gateway
- IAM

**Salesforce Components**
- Named Credential
- External Credential
- Apex service classes
- Lightning Web Component uploader

---

# Repo Structure

```
.
├── apex/
│   ├── S3PresignService.cls
│   ├── S3Uploader.cls
│   └── S3FileController.cls
│
├── lwc/awsFileUploader/
│   ├── awsFileUploader.html
│   ├── awsFileUploader.js
│   ├── awsFileUploader.js-meta.xml
│   └── awsFileUploader.css
│
├── lambda/generate-presigned-url/
│   ├── lambda_function.py
│
├── s3/
│   ├── cors.json
│
└── README.md
```

---

# Prerequisites

### AWS
- Access to S3, IAM, Lambda, API Gateway
- AWS CLI (optional)

### Salesforce
- Admin permissions
- Ability to deploy Apex + LWC
- Permission Set creation rights

---

# AWS Setup

## 1. Create S3 Bucket

Using CLI:

```bash
aws s3 mb s3://<BUCKET_NAME> --region <REGION>
```

Apply CORS:

```bash
aws s3api put-bucket-cors   --bucket <BUCKET_NAME>   --cors-configuration file://s3/cors.json
```

---

## 2. Configure IAM Role

IAM policy for Lambda:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["s3:PutObject", "s3:PutObjectAcl"],
      "Resource": "arn:aws:s3:::<BUCKET_NAME>/salesforce/uploads/*"
    }
  ]
}
```

Also attach `AWSLambdaBasicExecutionRole`.

---

## 3. Lambda Setup

- Runtime: **Python 3.9+**
- Handler: `lambda_function.lambda_handler`
- Environment Variables:
  ```
  ALLOWED_BUCKETS=<BUCKET_NAME>
  ```

Test Event:

```json
{
  "body": "{\"bucket\":\"<BUCKET_NAME>\",\"key\":\"salesforce/uploads/test.txt\",\"content_type\":\"text/plain\"}"
}
```

---

## 4. API Gateway Setup

REST API:

- `POST /generate-presigned`
- Lambda Proxy Integration
- Enable **API Key Required**
- Deploy to stage: `dev`, `prod`, etc.

Invoke URL:

```
https://<API_ID>.execute-api.<REGION>.amazonaws.com/<STAGE>
```

---

## 5. Usage Plan + API Key

- Create a **Usage Plan**
- Attach API stage
- Create **API Key**
- Link API Key → Usage Plan

This API key will be stored in Salesforce via External Credential.

---

# Salesforce Setup

## 1. External Credential

Setup → *External Credentials* → New:

- Name: `Presign_API_EC`
- Authentication Parameter:
  - Type: Header
  - Header Name: `x-api-key`
  - Value: `<API_KEY>`

---

## 2. Permission Set Mapping

- Create Permission Set: `Presign_API_Permissions`
- Assign to users
- Add Permission Set Mapping → `Presign_API_EC`

---

## 3. Named Credential

Setup → Named Credentials → New:

- Name: `Presign_API_NC`
- URL:
  ```
  https://<API_ID>.execute-api.<REGION>.amazonaws.com/<STAGE>
  ```
- Authentication Protocol: **Custom**
- External Credential: `Presign_API_EC`

Endpoint used in Apex:

```
callout:Presign_API_NC/generate-presigned
```

---

## 4. CSP Trusted Sites

Add:

```
https://<BUCKET_NAME>.s3.amazonaws.com
https://<BUCKET_NAME>.s3.<REGION>.amazonaws.com
```

Also add Experience Cloud URL if applicable.

---

## 5. Deploy Apex

Deploy:

- `S3PresignService.cls`
- `S3Uploader.cls`
- `S3FileController.cls`

Confirm that Apex uses:

```
callout:Presign_API_NC/generate-presigned
```

---

## 6. Deploy LWC

Deploy folder:

```
lwc/awsFileUploader
```

Add component to Record Page / App Page.

---

# Testing

### 1. Test Lambda
Use Lambda console with sample event.

### 2. Test API Gateway

```bash
curl -X POST "<INVOKE_URL>/generate-presigned"   -H "Content-Type: application/json"   -H "x-api-key: <API_KEY>"   -d '{"bucket":"<BUCKET>","key":"salesforce/uploads/test.txt"}'
```

### 3. Test Named Credential (Apex)

```apex
new S3PresignService().generatePresignedUrl('<bucket>', 'salesforce/uploads/test.txt', 'text/plain', 300);
```

### 4. Test LWC
Upload file → Network tab should show:

- `/generate-presigned` → 200
- `PUT <bucket-url>` → 200

---

# Troubleshooting

### 403 Forbidden (API Gateway)
- Missing API Key
- Stage not attached to Usage Plan
- Wrong Named Credential URL

### CORS Problems
- Ensure S3 CORS includes `OPTIONS`, `PUT`, and your Lightning domain
- Ensure correct bucket URL is whitelisted

### 403 PUT to S3
- Lambda IAM permission issue
- Misaligned prefix (`salesforce/uploads/`)
- Content-Type mismatch
- Expired presigned URL

---

# Security Notes

- Follow **least privilege IAM**
- Avoid `*` in CORS
- Keep presign expiration short (5–10 mins)
- Use server-side encryption (SSE-S3 or SSE-KMS)
- Rotate API keys routinely

---

# Appendix

Additional JSON configs, notes, and examples may be stored in the `s3/` and `lambda/` directories.
